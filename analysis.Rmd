---
title: "Energy Transition and Air Pollution Mortality: A Statistical Analysis"
author: "Inferential Statistics - Computer Engineering"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    theme: readable
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,           
  warning = FALSE,      
  message = FALSE,      
  fig.width = 10,       
  fig.height = 6,        
  fig.align = "center"   
)

# Load required libraries
# - tidyverse: data manipulation and visualization (includes ggplot2, dplyr)
# - corrplot: correlation matrix visualization
# - knitr: table formatting
library(tidyverse)
library(corrplot)
library(knitr)
library(dplyr)
library(ggplot2)

# Set a nice color palette for our plots
energy_colors <- c(
  "fossil" = "#8B4513",      
  "coal" = "#2F2F2F",        
  "gas" = "#FF8C00",       
  "nuclear" = "#32CD32",     
  "hydro" = "#1E90FF",       
  "solar" = "#FFD700",       
  "wind" = "#9400D3",
  "renewable" = "#228B22",       
  "low_carbon" = "#ff0000ff"  
)
```

## Research Questions

We formalize our research into five testable hypotheses:

1. **H0 (Low-Carbon Hypothesis)**: Higher share of low-carbon energy is associated 
   with lower air pollution mortality
2. **H1 (Coal-Gas Differential)**: Coal energy has a stronger association with 
   mortality than natural gas
3. **H2 (Nuclear Health Effect)**: Nuclear energy share correlates negatively 
   with mortality rates
4. **H4 (Renewable Threshold)**: Renewable energy effects may be non-linear 
   (threshold effects)
5. **HTest (GDP Confounder)**: Economic development confounds energy-mortality 
   relationships

## Statistical Methods Used

- **Descriptive statistics**: mean, median, standard deviation, quantiles
- **Correlation analysis**: Pearson's r with `cor.test()`
- **Two-sample tests**: Welch's t-test, Wilcoxon-Mann-Whitney
- **Multiple group comparisons**: One-way ANOVA, Kruskal-Wallis, pairwise t-tests 
  with Bonferroni correction
- **Regression analysis**: Simple and multiple linear regression with coefficient 
  testing

---

# Data Loading and Preparation

```{r load-data}
# ============================================================================
# DATA LOADING
# ============================================================================
# We load two datasets:
# 1. Energy data: share of different energy sources by country and year
# 2. Mortality data: air pollution attributable deaths by country and year
#
# Data sources:
# - Energy: Our World in Data (OWID) energy dataset
# - Mortality: WHO Global Health Observatory
# ============================================================================

energy_data <- read.csv("data/energy_clean.csv")
mortality_data <- read.csv("data/mortality_clean.csv")

cat("=== Energy Data Structure ===\n")
str(energy_data)

cat("\n=== Mortality Data Structure ===\n")
str(mortality_data)
```

```{r merge-data}
# ============================================================================
# DATA MERGING
# ============================================================================
# We merge energy and mortality data by country and year
# This creates our main analysis dataset
# ============================================================================

# Merge datasets on country (iso_code) and year
# Using inner join to keep only matching observations
df <- merge(
  energy_data, 
  mortality_data, 
  by = c("iso_code", "year"),
  all = FALSE  
)

cat(length(unique(energy_data$iso_code)), sep = " ", fill = FALSE, labels = NULL, append = FALSE)
# Check the merged result
cat("Merged dataset dimensions:", nrow(df), "rows x", ncol(df), "columns\n")
cat("Years available:", sort(unique(df$year)), "\n")
cat("Number of countries:", length(unique(df$iso_code)), "\n")
```

```{r create-variables}
# ============================================================================
# DERIVED VARIABLES
# ============================================================================
# We create additional variables useful for our analysis:
# - renewable_share: sum of all renewable sources
# - renewable_group: categorical grouping for ANOVA
# - has_nuclear: binary indicator for nuclear users
# ============================================================================

df$mortality_rate <- df$deaths / df$population * 100000

# Total renewable share (hydro + solar + wind + biofuel + other renewables)
df$renewable_share <- df$hydro_share_energy + df$solar_share_energy + 
                      df$wind_share_energy + df$biofuel_share_energy + 
                      df$other_renewables_share_energy

# Categorical grouping for renewable share (for ANOVA)
# Groups: Low (<20%), Medium (20-40%), High (>40%)
df$renewable_group <- cut(
  df$renewable_share,
  breaks = c(-Inf, 20, 40, Inf),
  labels = c("Low (<20%)", "Medium (20-40%)", "High (>40%)")
)

# Binary indicator: does this country use nuclear?
df$has_nuclear <- ifelse(df$nuclear_share_energy > 0, "Nuclear User", "No Nuclear")

# Display sample of the prepared data
df_sample <- head(df)
kable(df_sample, caption = "Sample of merged and prepared data")
```

---

# Descriptive Statistics and Visualizations

Before hypothesis testing, we thoroughly explore our data through descriptive 
statistics and visualizations. This helps us understand distributions, identify 
outliers, and check assumptions.

## Summary Statistics

```{r summary-energy}
# ============================================================================
# DESCRIPTIVE STATISTICS: ENERGY VARIABLES
# ============================================================================
# Calculate key statistics for all energy share variables
# Following the course approach: mean, sd, median, quantiles
# ============================================================================

# Select energy share columns - focusing on burnable vs low-carbon sources
energy_vars <- c("fossil_share_energy", "coal_share_energy", "gas_share_energy",
                 "nuclear_share_energy", "low_carbon_share_energy", "renewable_share")

# Calculate summary statistics
df_energy <- select(df, all_of(energy_vars))
energy_summary <- summarise(df_energy, across(everything(), list(
  n = ~sum(!is.na(.)),
  mean = ~mean(., na.rm = TRUE),
  sd = ~sd(., na.rm = TRUE),
  median = ~median(., na.rm = TRUE),
  q25 = ~quantile(
def clean_energy_data(data, year_period=[2010, 2020]):
    """
    Clean the OWID energy dataset.
    
    Steps:
    1. Remove rows without ISO codes (aggregates like "World", "Europe", etc.)
    2. Filter to specified year range
    3. Select only relevant columns (energy share variables)
    4. Handle missing values
    
    Parameters:
    -----------
    data : pd.DataFrame
        Raw OWID energy data
    year_period : list
        [start_year, end_year] inclusive range
        
    Returns:
    --------
    pd.DataFrame
        Cleaned energy data with selected columns
    """
    print(f"  Raw energy data: {data.shape[0]} rows, {data.shape[1]} columns")
    
    # Step 1: Remove rows without ISO codes (these are aggregates)
    # Known countries have 3-letter ISO codes; aggregates have longer codes or NaN
    data_clean = data[data["iso_code"].notna()].copy()
    data_clean = data_clean[data_clean["iso_code"].str.len() == 3]
    print(f"  After removing aggregates: {data_clean.shape[0]} rows")
    
    # Step 2: Filter to year range
    data_clean = data_clean[
        (data_clean["year"] >= year_period[0]) & 
        (data_clean["year"] <= year_period[1])
    ]
    print(f"  After year filter ({year_period[0]}-{year_period[1]}): {data_clean.shape[0]} rows")
    
    # Step 3: Select useful columns
    # These are the energy share variables (% of total energy)
    useful_columns = [
        # Identifiers
        "country",
        "year", 
        "iso_code",
        # Fossil fuel shares
        "fossil_share_energy",
        "coal_share_energy",
        "gas_share_energy",
        "oil_share_energy",
        # Low-carbon shares
        "low_carbon_share_energy",
        "nuclear_share_energy",
        "hydro_share_energy",
        "solar_share_energy",
        "wind_share_energy",
        "biofuel_share_energy",
        "other_renewables_share_energy",
        # Optional: GDP for confounding analysis
        "gdp",
        "population",
    ]
    
    # Keep only columns that exist in the data
    available_columns = [col for col in useful_columns if col in data_clean.columns]
    missing_columns = [col for col in useful_columns if col not in data_clean.columns]
    
    if missing_columns:
        print(f"  Warning: Missing columns: {missing_columns}")
    
    data_clean = data_clean[available_columns].copy()
    
    # Step 4: Create GDP per capita if GDP and population are available
    if "gdp" in data_clean.columns and "population" in data_clean.columns:
        data_clean["gdp_per_capita"] = data_clean["gdp"] / data_clean["population"]
        print("  Created gdp_per_capita variable")
    
    iso_codes = set(data_clean["iso_code"])

    # Step 5: Drop rows where key variables are all missing
    energy_cols = [col for col in data_clean.columns if "share_energy" in col]
    data_clean = data_clean.dropna(subset=energy_cols, how="all")
    print(f"  After dropping rows with all-missing energy data: {data_clean.shape[0]} rows")
    
    iso_codes_after = set(data_clean["iso_code"])

   

    print(f"  Final energy data: {data_clean.shape[0]} rows, {data_clean.shape[1]} columns")
    
    return data_clean
., 0.25, na.rm = TRUE),
  q75 = ~quantile(., 0.75, na.rm = TRUE)
)))
energy_summary <- pivot_longer(energy_summary, everything())
energy_summary <- separate(energy_summary, name, into = c("variable", "statistic"), sep = "_(?=[^_]+$)")
energy_summary <- pivot_wider(energy_summary, names_from = statistic, values_from = value)

# Clean up variable names for display
energy_summary$variable <- c("Fossil (total)", "Coal", "Gas", 
                              "Nuclear", "Low-Carbon (total)", "Renewable (total)")

# Display the table
energy_summary <- mutate(energy_summary, across(where(is.numeric), ~round(., 2)))
kable(energy_summary, caption = "Summary Statistics: Energy Source Shares (%)")
```

```{r summary-mortality}
# ============================================================================
# DESCRIPTIVE STATISTICS: MORTALITY VARIABLE
# ============================================================================
# Summary statistics for our outcome variable: air pollution mortality
# ============================================================================

mortality_summary <- summarise(df,
  n = sum(!is.na(mortality_rate)),
  mean = mean(mortality_rate, na.rm = TRUE),
  sd = sd(mortality_rate, na.rm = TRUE),
  median = median(mortality_rate, na.rm = TRUE),
  q25 = quantile(mortality_rate, 0.25, na.rm = TRUE),
  q75 = quantile(mortality_rate, 0.75, na.rm = TRUE),
  min = min(mortality_rate, na.rm = TRUE),
  max = max(mortality_rate, na.rm = TRUE)
)

mortality_summary <- mutate(mortality_summary, across(where(is.numeric), ~round(., 2)))
kable(mortality_summary, caption = "Summary Statistics: Air Pollution Mortality Rate")
```

## Visualizations

### Distribution of Key Variables

```{r hist-mortality, fig.cap="Distribution of air pollution mortality rates across all country-years"}
ggplot(df, aes(x = mortality_rate)) +
  geom_histogram(aes(y = after_stat(density)), 
                 bins = 30, 
                 fill = "steelblue", 
                 color = "white",
                 alpha = 0.7) +
  labs(
    title = "Distribution of Air Pollution Mortality Rates",
    x = "Mortality Rate (deaths per 100,000)",
    y = "Density"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

```{r hist-energy-sources, fig.height=8, fig.cap="Distribution of major energy source shares"}
# ============================================================================
# HISTOGRAMS: ENERGY SOURCE DISTRIBUTIONS
# ============================================================================
# Multiple histograms showing the distribution of different energy sources
# This helps identify skewness and potential outliers
# ============================================================================

# Reshape data for faceted plotting
df_select <- select(df, iso_code, year, fossil_share_energy, coal_share_energy, 
       gas_share_energy, nuclear_share_energy, low_carbon_share_energy,
       renewable_share)
df_long <- pivot_longer(df_select,
  cols = -c(iso_code, year),
  names_to = "energy_type",
  values_to = "share"
)
df_long$energy_type <- factor(df_long$energy_type, 
  levels = c("fossil_share_energy", "coal_share_energy", "gas_share_energy",
             "nuclear_share_energy", "renewable_share", "low_carbon_share_energy"),
  labels = c("Fossil", "Coal", "Gas", "Nuclear", "Renewable", "Low Carbon"))

ggplot(df_long, aes(x = share, fill = energy_type)) + 
  geom_histogram(bins = 25, color = "white", alpha = 0.8) + 
  facet_wrap(~energy_type, scales = "free_y", ncol = 2) + 
  scale_fill_manual(values = c("Fossil" = "#8B4513", "Coal" = "#2F2F2F", 
                               "Gas" = "#FF8C00", "Nuclear" = "#32CD32", 
                               "Renewable" = "#228B22", "Low Carbon" = "#ff0000ff")) + 
  labs(
    title = "Distribution of Energy Source Shares", 
    x = "Share of Total Energy (%)", 
    y = "Count" 
  ) + 
  theme_minimal() + 
  theme(legend.position = "none", 
        plot.title = element_text(face = "bold", size = 14)) 

print(energy_colors["fossil"]) 
```

### Boxplots for Group Comparisons

```{r boxplot-renewable-groups, fig.cap="Mortality rates by renewable energy adoption level"}
# ============================================================================
# BOXPLOT: MORTALITY BY RENEWABLE GROUPS
# ============================================================================
# Boxplots are excellent for comparing distributions across groups
# Course notes: "gives us insight about center, spread, and symmetry"
# ============================================================================

ggplot(df, aes(x = renewable_group, y = mortality_rate, fill = renewable_group)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 21) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  scale_fill_brewer(palette = "Greens") +
  labs(
    title = "Air Pollution Mortality by Renewable Energy Adoption Level",
    subtitle = "Boxplots with individual data points",
    x = "Renewable Energy Share Category",
    y = "Mortality Rate (per 100,000)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 14))
```

```{r boxplot-nuclear, fig.cap="Mortality comparison: nuclear vs non-nuclear countries"}
# ============================================================================
# BOXPLOT: NUCLEAR VS NON-NUCLEAR COUNTRIES
# ============================================================================
# Compare mortality distributions between countries with and without nuclear
# ============================================================================

ggplot(df, aes(x = has_nuclear, y = mortality_rate, fill = has_nuclear)) +
  geom_boxplot(alpha = 0.7, outlier.shape = 21) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  scale_fill_manual(values = c("Nuclear User" = "#9400D3", "No Nuclear" = "#A9A9A9")) +
  labs(
    title = "Air Pollution Mortality: Nuclear vs Non-Nuclear Countries",
    x = "Nuclear Energy Status",
    y = "Mortality Rate (per 100,000)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 14))
```

### Scatter Plots and Correlations

```{r scatter-lowcarbon, fig.cap="Relationship between low-carbon energy share and mortality"}
# ============================================================================
# SCATTER PLOT: LOW CARBON vs MORTALITY
# ============================================================================
# The scatter plot helps visualize the linear relationship
# We add a regression line to show the trend
# ============================================================================

ggplot(df, aes(x = low_carbon_share_energy, y = mortality_rate)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_smooth(method = "lm", color = "darkred", se = TRUE) +
  labs(
    title = "Low-Carbon Energy Share vs Air Pollution Mortality",
    subtitle = "Linear regression line with 95% confidence band",
    x = "Low-Carbon Energy Share (%)",
    y = "Mortality Rate (per 100,000)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

```{r scatter-matrix, fig.height=10, fig.width=10, fig.cap="Pairwise scatter plots of key variables"}
# ============================================================================
# SCATTER PLOT MATRIX
# ============================================================================
# Visualize all pairwise relationships between energy sources and mortality
# ============================================================================

pairs_vars <- select(df, mortality_rate, fossil_share_energy, coal_share_energy, 
       gas_share_energy, nuclear_share_energy, renewable_share)

pairs(pairs_vars, 
      main = "Pairwise Relationships: Energy Sources and Mortality",
      pch = 19, 
      col = adjustcolor("steelblue", alpha = 0.4),
      lower.panel = NULL)
```

```{r correlation-mortality, fig.cap="Correlation between energy sources and mortality"}
# ============================================================================
# CORRELATION WITH MORTALITY
# ============================================================================
# We focus on what matters: how each energy source correlates with mortality
# ============================================================================

# Select variables
cor_vars <- select(df, mortality_rate, fossil_share_energy, coal_share_energy, 
       gas_share_energy, nuclear_share_energy, low_carbon_share_energy,
       renewable_share)
cor_vars <- na.omit(cor_vars)

# Calculate correlations with mortality only
energy_cols <- setdiff(names(cor_vars), "mortality_rate")
correlations <- sapply(energy_cols, function(col) {
  cor(cor_vars$mortality_rate, cor_vars[[col]], use = "complete.obs")
})

# Create data frame for plotting
cor_df <- data.frame(
  energy_type = c("Fossil", "Coal", "Gas", "Nuclear", "Low-Carbon", "Renewable"),
  correlation = correlations
)
cor_df$energy_type <- factor(cor_df$energy_type, 
                              levels = cor_df$energy_type[order(cor_df$correlation)])

# Bar chart of correlations
ggplot(cor_df, aes(x = energy_type, y = correlation, 
                   fill = ifelse(correlation > 0, "Positive", "Negative"))) +
  geom_col(alpha = 0.8, width = 0.7) +
  geom_hline(yintercept = 0, linetype = "solid", color = "black") +
  geom_text(aes(label = sprintf("%.3f", correlation)), 
            hjust = ifelse(cor_df$correlation > 0, -0.1, 1.1), size = 3.5) +
  coord_flip() +
  scale_fill_manual(values = c("Positive" = "#D73027", "Negative" = "#1A9850")) +
  labs(
    title = "Correlation with Air Pollution Mortality",
    subtitle = "Pearson correlation coefficients",
    x = NULL,
    y = "Correlation with Mortality Rate"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 14)) +
  ylim(min(cor_df$correlation) - 0.1, max(cor_df$correlation) + 0.1)
```

---

# Hypothesis Testing

We now conduct formal hypothesis tests. For each hypothesis, we:

1. State the null and alternative hypotheses
2. Apply the appropriate test from the course
3. **Test across multiple years (2015, 2017, 2019) for temporal robustness**
4. Interpret the results

## H0: Low-Carbon Energy Reduces Mortality

**Hypothesis:**

- $H_0$: There is no correlation between low-carbon energy share and mortality 
  (ÃÂ = 0)
- $H_1$: Higher low-carbon share is associated with lower mortality (ÃÂ < 0)

**Method:** Pearson correlation test with `cor.test()`, and simple linear 
regression

```{r h0-correlation}
# ============================================================================
# H0: CORRELATION TEST - LOW CARBON vs MORTALITY
# ============================================================================
# We use cor.test() which provides:
# - Correlation coefficient (r)
# - P-value for testing H0: ÃÂ = 0
# - 95% confidence interval for ÃÂ
#
# We test across multiple years for temporal robustness
# ============================================================================

# Define years to test (temporal robustness)
test_years <- c(2015, 2017, 2019)

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H0: LOW-CARBON ENERGY AND MORTALITY - TEMPORAL ROBUSTNESS\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

# Store results for summary table
h0_results <- list()

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  # Filter data for this year
  df_yr <- filter(df, year == yr)
  
  # Skip if insufficient data
  if (nrow(df_yr) < 10) {
    cat("Insufficient data for this year\n\n")
    next
  }
  
  # Perform correlation test
  cor_test <- cor.test(
    df_yr$low_carbon_share_energy, 
    df_yr$mortality_rate,
    method = "pearson",
    alternative = "less"  # One-sided: expect negative correlation
  )
  
  # Store results
  h0_results[[as.character(yr)]] <- list(
    year = yr,
    n = nrow(df_yr),
    r = cor_test$estimate,
    p_value = cor_test$p.value,
    ci_lower = cor_test$conf.int[1],
    ci_upper = cor_test$conf.int[2]
  )
  
  # Print results
  cat(sprintf("  Sample size: n = %d\n", nrow(df_yr)))
  cat(sprintf("  Pearson r = %.4f\n", cor_test$estimate))
  cat(sprintf("  P-value = %.4f\n", cor_test$p.value))
  cat(sprintf("  95%% CI: [%.4f, %.4f]\n", cor_test$conf.int[1], cor_test$conf.int[2]))
  
  # Decision at ÃŽÂ± = 0.05
  if (cor_test$p.value < 0.05) {
    cat("  Decision: REJECT H0 - significant negative correlation\n\n")
  } else {
    cat("  Decision: FAIL TO REJECT H0\n\n")
  }
}
```

```{r h0-regression}
# ============================================================================
# H0: SIMPLE LINEAR REGRESSION
# ============================================================================
# Regression allows us to quantify the effect:
# mortality = ÃŽÂ²0 + ÃŽÂ²1 * low_carbon_share + ÃŽÂµ
#
# We're interested in ÃŽÂ²1: the change in mortality per 1% increase in low-carbon
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H0: LINEAR REGRESSION ANALYSIS\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  df_yr <- filter(df, year == yr)
  
  if (nrow(df_yr) < 10) {
    cat("Insufficient data\n\n")
    next
  }
  
  # Fit simple linear regression
  model <- lm(mortality_rate ~ low_carbon_share_energy, data = df_yr)
  
  # Print summary
  cat("\nRegression coefficients:\n")
  print(summary(model)$coefficients)
  cat(sprintf("\nR-squared: %.4f\n", summary(model)$r.squared))
  cat(sprintf("Residual SE: %.4f\n\n", summary(model)$sigma))
}
```

```{r h0-visualization, fig.cap="H0 Test: Low-carbon share vs mortality across years"}
# ============================================================================
# H0: VISUALIZATION ACROSS YEARS
# ============================================================================

df_test_years <- filter(df, year %in% test_years)

ggplot(df_test_years, aes(x = low_carbon_share_energy, y = mortality_rate)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_smooth(method = "lm", color = "darkred", se = TRUE) +
  facet_wrap(~year) +
  labs(
    title = "H0: Low-Carbon Energy vs Mortality (Temporal Robustness)",
    subtitle = "Separate regression lines for each year",
    x = "Low-Carbon Energy Share (%)",
    y = "Mortality Rate (per 100,000)"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(face = "bold", size = 14))
```

**Conclusion for H0:**

> *[TO BE COMPLETED BASED ON ACTUAL RESULTS]*

---

## H1: Coal Has Stronger Effect Than Gas

**Hypothesis:**

- $H_0$: Coal and gas have equal effects on mortality (ÃŽÂ²_coal = ÃŽÂ²_gas)
- $H_1$: Coal has a stronger positive effect than gas (ÃŽÂ²_coal > ÃŽÂ²_gas)

**Method:** Multiple regression comparing coefficients, or comparison of 
bivariate correlations

```{r h1-correlations}
# ============================================================================
# H1: COMPARE COAL AND GAS CORRELATIONS WITH MORTALITY
# ============================================================================
# We compute correlations for both coal and gas with mortality
# If coal has stronger effect, we expect |r_coal| > |r_gas| and both positive
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H1: COAL vs GAS EFFECT ON MORTALITY\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

h1_results <- list()

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  df_yr <- filter(df, year == yr)
  
  if (nrow(df_yr) < 10) {
    cat("Insufficient data\n\n")
    next
  }
  
  # Correlation: Coal vs Mortality
  cor_coal <- cor.test(df_yr$coal_share_energy, df_yr$mortality_rate)
  
  # Correlation: Gas vs Mortality  
  cor_gas <- cor.test(df_yr$gas_share_energy, df_yr$mortality_rate)
  
  cat(sprintf("  COAL: r = %.4f, p = %.4f\n", cor_coal$estimate, cor_coal$p.value))
  cat(sprintf("  GAS:  r = %.4f, p = %.4f\n", cor_gas$estimate, cor_gas$p.value))
  cat(sprintf("  Difference: r_coal - r_gas = %.4f\n\n", 
              cor_coal$estimate - cor_gas$estimate))
  
  h1_results[[as.character(yr)]] <- list(
    year = yr,
    r_coal = cor_coal$estimate,
    p_coal = cor_coal$p.value,
    r_gas = cor_gas$estimate,
    p_gas = cor_gas$p.value
  )
}
```

```{r h1-regression}
# ============================================================================
# H1: MULTIPLE REGRESSION WITH COAL AND GAS
# ============================================================================
# Model: mortality = ÃŽÂ²0 + ÃŽÂ²1*coal + ÃŽÂ²2*gas + ÃŽÂµ
# We compare ÃŽÂ²1 and ÃŽÂ²2 to see which has larger effect
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H1: MULTIPLE REGRESSION (Coal and Gas)\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  df_yr <- filter(df, year == yr)
  
  if (nrow(df_yr) < 10) {
    cat("Insufficient data\n\n")
    next
  }
  
  # Multiple regression
  model <- lm(mortality_rate ~ coal_share_energy + gas_share_energy, data = df_yr)
  
  cat("\nCoefficients:\n")
  print(summary(model)$coefficients)
  cat(sprintf("\nR-squared: %.4f\n\n", summary(model)$r.squared))
}
```

```{r h1-visualization, fig.height=8, fig.cap="H1 Test: Coal vs Gas effects on mortality"}
# ============================================================================
# H1: VISUALIZATION
# ============================================================================

p1 <- ggplot(df_test_years, aes(x = coal_share_energy, y = mortality_rate)) +
  geom_point(alpha = 0.5, color = "#2F2F2F") +
  geom_smooth(method = "lm", color = "darkred", se = TRUE) +
  facet_wrap(~year) +
  labs(title = "Coal Share vs Mortality", x = "Coal Share (%)", y = "Mortality Rate") +
  theme_minimal()

p2 <- ggplot(df_test_years, aes(x = gas_share_energy, y = mortality_rate)) +
  geom_point(alpha = 0.5, color = "#FF8C00") +
  geom_smooth(method = "lm", color = "darkred", se = TRUE) +
  facet_wrap(~year) +
  labs(title = "Gas Share vs Mortality", x = "Gas Share (%)", y = "Mortality Rate") +
  theme_minimal()

# Combine plots
gridExtra::grid.arrange(p1, p2, nrow = 2)
```

**Conclusion for H1:**

> *[TO BE COMPLETED BASED ON ACTUAL RESULTS]*

---

## H2: Nuclear Energy Health Effect

**Hypothesis:**

- $H_0$: Nuclear energy share has no correlation with mortality (ÃÂ = 0)
- $H_1$: Nuclear energy share is negatively correlated with mortality (ÃÂ < 0)

**Additional test:** Two-sample comparison between nuclear and non-nuclear countries

```{r h2-correlation}
# ============================================================================
# H2: NUCLEAR CORRELATION TEST
# ============================================================================
# Test correlation between nuclear share and mortality
# We also compare nuclear-using vs non-nuclear countries
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H2: NUCLEAR ENERGY AND MORTALITY\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

h2_results <- list()

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  df_yr <- filter(df, year == yr)
  
  if (nrow(df_yr) < 10) {
    cat("Insufficient data\n\n")
    next
  }
  
  # Test 1: Correlation (among all countries)
  cor_test <- cor.test(
    df_yr$nuclear_share_energy, 
    df_yr$mortality_rate,
    method = "pearson"
  )
  
  cat("Correlation test (all countries):\n")
  cat(sprintf("  r = %.4f, p = %.4f\n\n", cor_test$estimate, cor_test$p.value))
  
  # Test 2: Correlation (only nuclear users)
  df_nuclear <- filter(df_yr, nuclear_share_energy > 0)
  
  if (nrow(df_nuclear) >= 5) {
    cor_nuclear <- cor.test(
      df_nuclear$nuclear_share_energy,
      df_nuclear$mortality_rate,
      method = "pearson"
    )
    cat("Correlation (nuclear users only, n =", nrow(df_nuclear), "):\n")
    cat(sprintf("  r = %.4f, p = %.4f\n\n", cor_nuclear$estimate, cor_nuclear$p.value))
  }
  
  h2_results[[as.character(yr)]] <- list(
    year = yr,
    r = cor_test$estimate,
    p_value = cor_test$p.value
  )
}
```

```{r h2-ttest}
# ============================================================================
# H2: TWO-SAMPLE T-TEST (Nuclear vs Non-Nuclear Countries)
# ============================================================================
# Compare mean mortality between countries with/without nuclear energy
# Following course methods: Welch's t-test (doesn't assume equal variances)
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H2: TWO-SAMPLE T-TEST (Nuclear vs Non-Nuclear)\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  df_yr <- filter(df, year == yr)
  
  nuclear_group <- df_yr[df_yr$has_nuclear == "Nuclear User", "mortality_rate"]
  no_nuclear_group <- df_yr[df_yr$has_nuclear == "No Nuclear", "mortality_rate"]
  
  if (length(nuclear_group) < 3 || length(no_nuclear_group) < 3) {
    cat("Insufficient data in one or both groups\n\n")
    next
  }
  
  # Welch's t-test
  t_test <- t.test(nuclear_group, no_nuclear_group, alternative = "less")
  
  # Also run Wilcoxon as non-parametric alternative
  wilcox_test <- wilcox.test(nuclear_group, no_nuclear_group, alternative = "less")
  
  cat(sprintf("  Nuclear users (n=%d): mean = %.2f, sd = %.2f\n", 
              length(nuclear_group), mean(nuclear_group), sd(nuclear_group)))
  cat(sprintf("  Non-nuclear (n=%d): mean = %.2f, sd = %.2f\n",
              length(no_nuclear_group), mean(no_nuclear_group), sd(no_nuclear_group)))
  cat(sprintf("\n  Welch t-test: t = %.4f, p = %.4f\n", t_test$statistic, t_test$p.value))
  cat(sprintf("  Wilcoxon test: W = %.1f, p = %.4f\n\n", 
              wilcox_test$statistic, wilcox_test$p.value))
}
```

```{r h2-visualization, fig.cap="H2 Test: Nuclear energy effect on mortality"}
# ============================================================================
# H2: VISUALIZATION
# ============================================================================

ggplot(df_test_years, aes(x = has_nuclear, y = mortality_rate, fill = has_nuclear)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  facet_wrap(~year) +
  scale_fill_manual(values = c("Nuclear User" = "#9400D3", "No Nuclear" = "#A9A9A9")) +
  labs(
    title = "H2: Mortality by Nuclear Energy Status (Temporal Robustness)",
    x = "Nuclear Status",
    y = "Mortality Rate (per 100,000)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(face = "bold", size = 14))
```

**Conclusion for H2:**

> *[TO BE COMPLETED BASED ON ACTUAL RESULTS]*

---

## H4: Renewable Energy Threshold Effects

**Hypothesis:**

- $H_0$: All renewable energy groups have equal mean mortality
- $H_1$: At least one group differs (threshold/non-linear effect)

**Method:** One-way ANOVA followed by pairwise comparisons with Bonferroni 
correction. Also Kruskal-Wallis as non-parametric alternative.

```{r h4-anova}
# ============================================================================
# H4: ONE-WAY ANOVA - RENEWABLE GROUPS
# ============================================================================
# We test whether mortality differs across renewable energy adoption levels
# Groups: Low (<20%), Medium (20-40%), High (>40%)
#
# From course notes: ANOVA tests H0: ÃŽÂ¼1 = ÃŽÂ¼2 = ... = ÃŽÂ¼k
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H4: RENEWABLE ENERGY THRESHOLD - ONE-WAY ANOVA\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

h4_results <- list()

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  df_yr <- filter(df, year == yr)
  df_yr <- df_yr[!is.na(df_yr$renewable_group), ]
  
  # Check group sizes
  group_sizes <- table(df_yr$renewable_group)
  cat("Group sizes:\n")
  print(group_sizes)
  
  if (any(group_sizes < 3)) {
    cat("Warning: Some groups have < 3 observations\n\n")
  }
  
  # Group means
  group_means <- aggregate(
    mortality_rate ~ renewable_group,
    data = df_yr,
    FUN = function(x) c(n = length(x), mean = mean(x, na.rm = TRUE), sd = sd(x, na.rm = TRUE))
  )
  cat("\nGroup statistics:\n")
  print(as.data.frame(group_means))
  
  # ANOVA (assuming equal variances)
  aov_result <- aov(mortality_rate ~ renewable_group, data = df_yr)
  cat("\nANOVA table:\n")
  print(summary(aov_result))
  
  # Extract F and p
  aov_summary <- summary(aov_result)[[1]]
  f_stat <- aov_summary$`F value`[1]
  p_value <- aov_summary$`Pr(>F)`[1]
  
  # Welch ANOVA (not assuming equal variances)
  welch_result <- oneway.test(mortality_rate ~ renewable_group, data = df_yr)
  cat(sprintf("\nWelch ANOVA: F = %.4f, p = %.4f\n", 
              welch_result$statistic, welch_result$p.value))
  
  # Kruskal-Wallis (non-parametric)
  kw_result <- kruskal.test(mortality_rate ~ renewable_group, data = df_yr)
  cat(sprintf("Kruskal-Wallis: Ãâ€¡Ã‚Â² = %.4f, p = %.4f\n\n", 
              kw_result$statistic, kw_result$p.value))
  
  h4_results[[as.character(yr)]] <- list(
    year = yr,
    f_stat = f_stat,
    p_anova = p_value,
    p_welch = welch_result$p.value,
    p_kw = kw_result$p.value
  )
}
```

```{r h4-pairwise}
# ============================================================================
# H4: PAIRWISE COMPARISONS (if ANOVA is significant)
# ============================================================================
# Use Bonferroni correction to control family-wise error rate
# From course notes: "corrected p-values so probability of FP > 0 is Ã¢â€°Â¤ ÃŽÂ±"
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("H4: PAIRWISE T-TESTS WITH BONFERRONI CORRECTION\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

for (yr in test_years) {
  cat(paste0("--- Year ", yr, " ---\n"))
  
  df_yr <- filter(df, year == yr)
  df_yr <- df_yr[!is.na(df_yr$renewable_group), ]
  
  # Pairwise t-tests with Bonferroni correction
  pairwise_result <- pairwise.t.test(
    df_yr$mortality_rate,
    df_yr$renewable_group,
    p.adjust.method = "bonferroni"
  )
  
  cat("\nP-values (Bonferroni adjusted):\n")
  print(pairwise_result$p.value)
  cat("\n")
  
  # Also Tukey HSD if ANOVA model is available
  aov_model <- aov(mortality_rate ~ renewable_group, data = df_yr)
  cat("Tukey HSD:\n")
  print(TukeyHSD(aov_model))
  cat("\n")
}
```

```{r h4-visualization, fig.cap="H4 Test: Renewable threshold effects across years"}
# ============================================================================
# H4: VISUALIZATION
# ============================================================================

ggplot(df_test_years[!is.na(df_test_years$renewable_group), ], 
       aes(x = renewable_group, y = mortality_rate, fill = renewable_group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 1) +
  facet_wrap(~year) +
  scale_fill_brewer(palette = "Greens") +
  labs(
    title = "H4: Mortality by Renewable Energy Group (Temporal Robustness)",
    subtitle = "Testing for threshold/non-linear effects",
    x = "Renewable Energy Category",
    y = "Mortality Rate (per 100,000)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 15, hjust = 1),
        plot.title = element_text(face = "bold", size = 14))
```

**Conclusion for H4:**

> *[TO BE COMPLETED BASED ON ACTUAL RESULTS]*

---

## HTest: GDP as Confounder

**Purpose:** Economic development (GDP) may confound the energy-mortality 
relationship. Wealthier countries can afford cleaner energy AND better healthcare.

**Method:** 
1. Test correlation between GDP and both energy/mortality variables
2. Include GDP as covariate in regression models

```{r htest-correlations}
# ============================================================================
# HTest: GDP CONFOUNDING ANALYSIS
# ============================================================================
# Check if GDP is correlated with both energy shares and mortality
# If so, we need to control for it in our analyses
# ============================================================================

cat(paste(rep("=", 70), collapse = ""), "\n")
cat("HTest: GDP CONFOUNDING ANALYSIS\n")
cat(paste(rep("=", 70), collapse = ""), "\n\n")

# Check if GDP variable exists
if ("gdp_per_capita" %in% names(df)) {
  
  for (yr in test_years) {
    cat(paste0("--- Year ", yr, " ---\n"))
    
    df_yr <- filter(df, year == yr)
    
    # GDP vs Mortality
    cor_gdp_mort <- cor.test(df_yr$gdp_per_capita, df_yr$mortality_rate, 
                              use = "complete.obs")
    cat(sprintf("GDP vs Mortality: r = %.4f, p = %.4f\n", 
                cor_gdp_mort$estimate, cor_gdp_mort$p.value))
    
    # GDP vs Low Carbon
    cor_gdp_lc <- cor.test(df_yr$gdp_per_capita, df_yr$low_carbon_share_energy,
                           use = "complete.obs")
    cat(sprintf("GDP vs Low-Carbon: r = %.4f, p = %.4f\n\n", 
                cor_gdp_lc$estimate, cor_gdp_lc$p.value))
  }
  
} else {
  cat("GDP variable not available in dataset.\n")
  cat("Confounding analysis cannot be performed.\n")
  cat("Consider adding GDP data for a more robust analysis.\n")
}
```

```{r htest-controlled-regression}
# ============================================================================
# HTest: REGRESSION CONTROLLING FOR GDP
# ============================================================================
# If GDP data available, fit model: mortality ~ low_carbon + GDP
# Compare to model without GDP to see if conclusions change
# ============================================================================

if ("gdp_per_capita" %in% names(df)) {
  
  cat(paste(rep("=", 70), collapse = ""), "\n")
  cat("HTest: REGRESSION WITH GDP CONTROL\n")
  cat(paste(rep("=", 70), collapse = ""), "\n\n")
  
  for (yr in test_years) {
    cat(paste0("--- Year ", yr, " ---\n"))
    
    df_yr <- na.omit(filter(df, year == yr))
    
    # Model without GDP
    model1 <- lm(mortality_rate ~ low_carbon_share_energy, data = df_yr)
    
    # Model with GDP
    model2 <- lm(mortality_rate ~ low_carbon_share_energy + gdp_per_capita, data = df_yr)
    
    cat("\nModel 1 (without GDP control):\n")
    print(summary(model1)$coefficients)
    
    cat("\nModel 2 (with GDP control):\n")
    print(summary(model2)$coefficients)
    
    cat(sprintf("\nRÃ‚Â² without GDP: %.4f\n", summary(model1)$r.squared))
    cat(sprintf("RÃ‚Â² with GDP: %.4f\n\n", summary(model2)$r.squared))
  }
}
```

**Conclusion for HTest:**

> *[TO BE COMPLETED BASED ON ACTUAL RESULTS]*

---

# Summary of Results

```{r summary-table}
# ============================================================================
# SUMMARY TABLE OF ALL HYPOTHESIS TESTS
# ============================================================================
# Compile all results into a single summary table
# ============================================================================

# Create summary data frame
# Note: This will need adjustment based on actual results structure

summary_table <- data.frame(
  Hypothesis = c("H0: Low-carbon reduces mortality",
                 "H1: Coal > Gas effect",
                 "H2: Nuclear negative effect",
                 "H4: Renewable threshold",
                 "HTest: GDP confounding"),
  Method = c("Correlation/Regression",
             "Multiple Regression",
             "t-test/Correlation",
             "ANOVA",
             "Correlation/Regression"),
  Years_Tested = rep("2015, 2017, 2019", 5),
  Conclusion = c("[TO BE COMPLETED]",
                 "[TO BE COMPLETED]",
                 "[TO BE COMPLETED]",
                 "[TO BE COMPLETED]",
                 "[TO BE COMPLETED]")
)

kable(summary_table, caption = "Summary of Hypothesis Testing Results")
```

---

# Conclusions

## Key Findings

> *[TO BE COMPLETED BASED ON ACTUAL RESULTS]*

## Limitations

1. **Cross-sectional analysis**: We analyze snapshots in time, not causal effects
2. **Ecological fallacy**: Country-level data may not reflect individual-level effects
3. **Missing confounders**: Other factors (urbanization, industrial composition, etc.) not controlled
4. **Data quality**: WHO mortality estimates have inherent uncertainty

## Recommendations for Future Work

> *[TO BE COMPLETED]*

---

# Appendix: R Session Info

```{r session-info}
sessionInfo()
```